name: Merge-upstream
on:
  # å½“ä»£ç æŽ¨é€åˆ°ä»“åº“æ—¶è§¦å‘ã€‚
  # push:
  #   # æŒ‡å®šæ–‡ä»¶è·¯å¾„ä¼šè§¦å‘å·¥ä½œæµç¨‹
  #   paths:
  #     - '.github/workflows/upstream.yml'
  #     - '.gitignore'
  #     - '.github/diy/**'
  # # æŒ‰è®¡åˆ’å®šæœŸè§¦å‘ï¼Œä¾‹å¦‚æ¯ 12 å°æ—¶ä¸€æ¬¡ã€‚
  # schedule:
  #   - cron: 0 */12 * * *
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµç¨‹ã€‚
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ssh'
        required: false
        default: 'false'
  # # å½“ä»“åº“è¢«å…³æ³¨æ—¶è§¦å‘ã€‚
  # watch:
  #   types: started
  # # é€šè¿‡å¤–éƒ¨äº‹ä»¶è§¦å‘ã€‚
  # repository_dispatch:

jobs:
  merge:
    runs-on: Ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main
    
    - name: Set git identity è®¾ç½®gitæ ‡è¯†
      run : |
        git config --global user.email "54346276+asxs123@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        sudo timedatectl set-timezone "Asia/Shanghai"

    - name: Syn upstream  åŒæ­¥ä¸Šæ¸¸
      run: |
        # éåŽ† tvboxlist.txt æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œ
        while IFS=, read -r url_name url; do
          # ä½¿ç”¨ curl æ‰§è¡Œ POST è¯·æ±‚
          curl -X POST -H 'Content-Type: application/json; charset=UTF-8' -d "{\"url\":\"$url\"}" https://api.lige.chat/ua > "${url_name}.json"
        done < tvboxlist.txt
        
    - name: Apply åº”ç”¨
      run: |
        # å®šä¹‰äº†ä¸€ä¸ªæ•°ç»„ Emojiï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ªä¸åŒçš„ emoji è¡¨æƒ…
        Emoji=("ðŸŽ‰" "ðŸ¤ž" "âœ¨" "ðŸŽ" "ðŸŽˆ" "ðŸŽ„" "ðŸŽ¨" "ðŸ’‹" "ðŸ“" "ðŸ•" "ðŸ‰" "ðŸ’" "ðŸŒ´" "ðŸš€" "ðŸ›¸" "ðŸ—½" "â›…" "ðŸŒˆ" "ðŸ”¥" "â›„" "ðŸ¶" "ðŸ…" "ðŸ¦„" "ðŸ¤")
        # å°†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ·»åŠ åˆ° Git æš‚å­˜åŒº
        git add .
        # åˆ›å»ºä¸€ä¸ªæäº¤ï¼ŒåŒ…å«äº†éšæœºé€‰æ‹©çš„ emoji å’Œå½“å‰æ—¥æœŸæ—¶é—´ä½œä¸ºæäº¤ä¿¡æ¯
        git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(date +%Y-%m-%d" "%H:%M:%S)"
        # æ’¤é”€ä¸Šä¸€æ¬¡æäº¤ï¼Œä½†ä¿ç•™æ›´æ”¹
        git reset --soft HEAD^
        git add .
        git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(date +%Y-%m-%d" "%H:%M:%S)"
        # å¼ºåˆ¶æŽ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“
        git push -f

    - name: Delete workflow runs åˆ é™¤å·¥ä½œæµè¿è¡Œ
      uses: Mattraks/delete-workflow-runs@main
      continue-on-error: true
      with:
        retain_days: 1
        keep_minimum_runs: 3
