name: Merge-upstream
on:
  # å½“ä»£ç æ¨é€åˆ°ä»“åº“æ—¶è§¦å‘ã€‚
  # push:
  #   # æŒ‡å®šæ–‡ä»¶è·¯å¾„ä¼šè§¦å‘å·¥ä½œæµç¨‹
  #   paths:
  #     - '.github/workflows/upstream.yml'
  #     - '.gitignore'
  #     - '.github/diy/**'
  # # æŒ‰è®¡åˆ’å®šæœŸè§¦å‘ï¼Œä¾‹å¦‚æ¯ 12 å°æ—¶ä¸€æ¬¡ã€‚
  # schedule:
  #   - cron: 0 */12 * * *
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµç¨‹ã€‚
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ssh'
        required: false
        default: 'false'
  # # å½“ä»“åº“è¢«å…³æ³¨æ—¶è§¦å‘ã€‚
  # watch:
  #   types: started
  # # é€šè¿‡å¤–éƒ¨äº‹ä»¶è§¦å‘ã€‚
  # repository_dispatch:

jobs:
  merge:
    runs-on: Ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main
      with:
        fetch-depth: 0
    
    - name: Set git identity è®¾ç½®gitæ ‡è¯†
      run : |
        git config --global user.email "54346276+asxs123@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        sudo timedatectl set-timezone "Asia/Shanghai"

    - name: Syn upstream  åŒæ­¥ä¸Šæ¸¸
      run: |
        # å…³é—­è„šæœ¬ä¸­çš„é”™è¯¯ç»ˆæ­¢
        set +e
        set -x  # å¼€å¯æ‰§è¡Œè·Ÿè¸ª

        rm -f tvboxlist/*.json
        # éå† tvboxlist.txt æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œ
        while IFS=, read -r url_name url && url=$(echo "$url" | tr -d '\r'); do
          # å»é™¤ url å˜é‡ä¸­çš„å›è½¦ç¬¦ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          # æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ IFS=, å·²ç»æ­£ç¡®åœ°å°†è¾“å…¥åˆ†å‰²æˆäº† url_name å’Œ url
          # ä½†æ˜¯ï¼Œå¦‚æœ url æœ¬èº«åŒ…å«é€—å·ï¼Œè¿™ç§æ–¹æ³•å¯èƒ½ä¸é€‚ç”¨ã€‚ä¸è¿‡ï¼Œåœ¨æ‚¨çš„åœºæ™¯ä¸­ï¼Œ
          # å¦‚æœ url æ˜¯ä½œä¸ºå•ç‹¬çš„å­—æ®µè¯»å–çš„ï¼Œå¹¶ä¸”é€—å·ä»…ç”¨ä½œå­—æ®µåˆ†éš”ç¬¦ï¼Œé‚£ä¹ˆè¿™åº”è¯¥æ˜¯æ²¡é—®é¢˜çš„ã€‚
          # ä½¿ç”¨ curl æ‰§è¡Œ POST è¯·æ±‚
          json_data=$(printf '{"url":"%s"}' "$url")
          # curl -X POST -H 'Content-Type: application/json; charset=UTF-8' -d "$json_data" https://api.lige.chat/ua > "tvboxlist/${url_name}.json"
          response=$(curl -s -X POST -H 'Content-Type: application/json; charset=UTF-8' -d "$json_data" https://api.lige.chat/ua 2>&1)
          # æ£€æŸ¥è¾“å‡ºæ˜¯å¦åŒ…å« "sites":
          if [[ ! "$response" == *"\"sites\":"* ]]; then
            # åœ¨è¿™é‡Œæ‰§è¡Œæ–°çš„ curl å‘½ä»¤æˆ–å…¶ä»–æ“ä½œ
            # ä¾‹å¦‚ï¼Œå†æ¬¡å‘é€è¯·æ±‚åˆ°ä¸€ä¸ªä¸åŒçš„ç«¯ç‚¹æˆ–è®°å½•é”™è¯¯
            new_response=$(curl -L https://www.xn--sss604efuw.com/jm/jiemi.php?url="$url")
            if [[ ! "$new_response" == *"\"sites\":"* ]]; then
              echo "${url_name} error"
            else
              echo "$new_response" > "tvboxlist/${url_name}.json"
            fi
          else
            # å¦‚æœåŒ…å« "sites":ï¼Œåˆ™å¤„ç†æ­£å¸¸å“åº”ï¼ˆä¾‹å¦‚ä¿å­˜åˆ°æ–‡ä»¶ï¼‰
            echo "$response" > "tvboxlist/${url_name}.json"
          fi
          # æ·»åŠ å»¶æ—¶ï¼Œä¾‹å¦‚æ¯ç§’å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ˆ3ç§’å»¶æ—¶ï¼‰
          sleep 3
        done < tvboxlist/tvboxlist.txt
        
    - name: Apply åº”ç”¨
      run: |
        # å®šä¹‰äº†ä¸€ä¸ªæ•°ç»„ Emojiï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ªä¸åŒçš„ emoji è¡¨æƒ…
        Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
        # å°†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ·»åŠ åˆ° Git æš‚å­˜åŒº
        git add .
        # åˆ›å»ºä¸€ä¸ªæäº¤ï¼ŒåŒ…å«äº†éšæœºé€‰æ‹©çš„ emoji å’Œå½“å‰æ—¥æœŸæ—¶é—´ä½œä¸ºæäº¤ä¿¡æ¯
        git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(date +%Y-%m-%d" "%H:%M:%S)"
        # æ’¤é”€ä¸Šä¸€æ¬¡æäº¤ï¼Œä½†ä¿ç•™æ›´æ”¹
        git reset --soft HEAD^
        git add .
        git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(date +%Y-%m-%d" "%H:%M:%S)"
        # å¼ºåˆ¶æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“
        git push -f

    - name: Delete workflow runs åˆ é™¤å·¥ä½œæµè¿è¡Œ
      uses: Mattraks/delete-workflow-runs@main
      continue-on-error: true
      with:
        retain_days: 1
        keep_minimum_runs: 3