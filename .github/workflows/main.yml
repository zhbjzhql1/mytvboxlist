name: Merge-upstream
on:
  # å½“ä»£ç æ¨é€åˆ°ä»“åº“æ—¶è§¦å‘ã€‚
  # push:
  #   # æŒ‡å®šæ–‡ä»¶è·¯å¾„ä¼šè§¦å‘å·¥ä½œæµç¨‹
  #   paths:
  #     - '.github/workflows/upstream.yml'
  #     - '.gitignore'
  #     - '.github/diy/**'
  # # æŒ‰è®¡åˆ’å®šæœŸè§¦å‘ï¼Œä¾‹å¦‚æ¯ 12 å°æ—¶ä¸€æ¬¡ã€‚
  # schedule:
  #   - cron: 0 */12 * * *
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµç¨‹ã€‚
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ssh'
        required: false
        default: 'false'
  # # å½“ä»“åº“è¢«å…³æ³¨æ—¶è§¦å‘ã€‚
  # watch:
  #   types: started
  # # é€šè¿‡å¤–éƒ¨äº‹ä»¶è§¦å‘ã€‚
  # repository_dispatch:

jobs:
  merge:
    runs-on: Ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main
      with:
        fetch-depth: 0
    
    - name: Set git identity è®¾ç½®gitæ ‡è¯†
      run : |
        git config --global user.email "54346276+asxs123@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        sudo timedatectl set-timezone "Asia/Shanghai"

    - name: Syn upstream  åŒæ­¥ä¸Šæ¸¸
      run: |
        # å¯ç”¨æ‰©å±•çš„æ¨¡å¼åŒ¹é…
        shopt -s extglob
        # å…³é—­è„šæœ¬ä¸­çš„é”™è¯¯ç»ˆæ­¢
        set +e
        # ä»ç¼“å­˜ä¸­åˆ é™¤æ‰€æœ‰æ–‡ä»¶,ä¸æ˜¾ç¤ºä»»ä½•è¾“å‡º
        git rm -r --cache * >/dev/null 2>&1 &
        # åˆ é™¤é™¤ .github/diy ä»¥å¤–çš„æ‰€æœ‰æ–‡ä»¶å¤¹ã€‚find æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤¹ï¼Œ-maxdepth 0 åªæœç´¢å½“å‰ç›®å½•ï¼Œ-type d åªæœç´¢æ–‡ä»¶å¤¹ï¼Œ! -name ".github/diy" æ’é™¤åä¸º .github/diy çš„æ–‡ä»¶å¤¹ã€‚
        rm -rf `find ./* -maxdepth 0 -type d ! -name "app/src/main/java/com/github/catvod/spider"` >/dev/null 2>&1
        function git_clone() {
          # å…‹éš†æŒ‡å®šä»“åº“ --depth 1 åªå…‹éš†æœ€è¿‘ä¸€æ¬¡æäº¤ $1 å’Œ $2 æ˜¯å‡½æ•°çš„å‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºä»“åº“ URL å’Œç›®æ ‡ç›®å½•ã€‚
          git clone --depth 1 $1 $2
          if [ "$?" != 0 ]; then
            # å‘½ä»¤æ‰§è¡Œå¤±è´¥,è¾“å‡ºé”™è¯¯ä¿¡æ¯,è·å–å½“å‰è¿›ç¨‹çš„ PID,ç»ˆæ­¢å½“å‰è¿›ç¨‹
            echo "error on $1"
            pid="$( ps -q $$ )"
            kill $pid
          fi
        }
        (
          curl -X POST -H 'Content-Type: application/json; charset=UTF-8' -d '{"url":"http://www.é¥­å¤ªç¡¬.com/tv"}' https://api.lige.chat/ua > Douban.json
        )
        
    - name: Apply åº”ç”¨
      run: |
        # å®šä¹‰äº†ä¸€ä¸ªæ•°ç»„ Emojiï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ªä¸åŒçš„ emoji è¡¨æƒ…
        Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
        # å°†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ·»åŠ åˆ° Git æš‚å­˜åŒº
        git add .
        # åˆ›å»ºä¸€ä¸ªæäº¤ï¼ŒåŒ…å«äº†éšæœºé€‰æ‹©çš„ emoji å’Œå½“å‰æ—¥æœŸæ—¶é—´ä½œä¸ºæäº¤ä¿¡æ¯
        git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(date +%Y-%m-%d" "%H:%M:%S)"
        # æ’¤é”€ä¸Šä¸€æ¬¡æäº¤ï¼Œä½†ä¿ç•™æ›´æ”¹
        git reset --soft HEAD^
        git add .
        git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(date +%Y-%m-%d" "%H:%M:%S)"
        # å¼ºåˆ¶æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“
        git push -f

    - name: Delete workflow runs åˆ é™¤å·¥ä½œæµè¿è¡Œ
      uses: Mattraks/delete-workflow-runs@main
      continue-on-error: true
      with:
        retain_days: 1
        keep_minimum_runs: 3
