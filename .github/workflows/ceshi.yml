name: iptv-upstream
on:
  # å½“ä»£ç æ¨é€åˆ°ä»“åº“æ—¶è§¦å‘ã€‚
  # push:
  #   # æŒ‡å®šæ–‡ä»¶è·¯å¾„ä¼šè§¦å‘å·¥ä½œæµç¨‹
  #   paths:
  #     - '.github/workflows/upstream.yml'
  #     - '.gitignore'
  #     - '.github/diy/**'
  # # æŒ‰è®¡åˆ’å®šæœŸè§¦å‘ï¼Œä¾‹å¦‚æ¯ 12 å°æ—¶ä¸€æ¬¡ã€‚
  # schedule:
  #   - cron: 0 */12 * * *
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµç¨‹ã€‚
  schedule:
    - cron: '30 21 */3 * *'
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ssh'
        required: false
        default: 'false'
  # # å½“ä»“åº“è¢«å…³æ³¨æ—¶è§¦å‘ã€‚
  # watch:
  #   types: started
  # # é€šè¿‡å¤–éƒ¨äº‹ä»¶è§¦å‘ã€‚
  # repository_dispatch:

jobs:
  merge:
    runs-on: Ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main
      with:
        fetch-depth: 0
    
    - name: Set git identity è®¾ç½®gitæ ‡è¯†
      run : |
        git config --global user.email "54346276+asxs123@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        sudo timedatectl set-timezone "Asia/Shanghai"

    - name: Syn upstream  åŒæ­¥ä¸Šæ¸¸
      run: |
        rm -f tvboxlist/iptv.txt
        # # éå† iptvlist.txt æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œ
        # while IFS= read -r url && url=$(echo "$url" | tr -d '\r'); do
        #   new_response=$(curl -L "$url")
        #   echo "$new_response" >> tvboxlist/iptv.txt
        #   echo >> tvboxlist/iptv.txt
        #   # æ·»åŠ å»¶æ—¶ï¼Œä¾‹å¦‚æ¯ç§’å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ˆ3ç§’å»¶æ—¶ï¼‰
        #   sleep 3
        # done < .github/workflows/iptv/iptvlist.txt

        # æœ€å¤§é‡è¯•æ¬¡æ•°
        MAX_RETRIES=3
        # åˆå§‹é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰
        RETRY_DELAY=3

        while IFS= read -r url; do
          # å»é™¤å¯èƒ½å­˜åœ¨çš„Windowsæ¢è¡Œç¬¦
          url=$(echo "$url" | tr -d '\r')
          
          # åˆå§‹åŒ–é‡è¯•è®¡æ•°å™¨
          retries=0
          success=false

          while [ $retries -le $MAX_RETRIES ]; do
            # å‘é€è¯·æ±‚
            new_response=$(curl -Ls "$url" -w "%{http_code}") # åŒ…å«HTTPçŠ¶æ€ç 
            
            # åˆ†ç¦»HTTPçŠ¶æ€ç å’Œå“åº”ä½“
            http_code=${new_response: -3}
            body=${new_response%???}

            # æ£€æŸ¥æ˜¯å¦åŒ…å«é”™è¯¯ä¿¡æ¯æˆ–HTTPçŠ¶æ€ç å¼‚å¸¸
            if [[ "$body" == *"ChmlFrp-é”™è¯¯è­¦å‘Š"* || "$body" == *"ç›´æ’­æºä¸­è½‰ç«™"* || $http_code -ge 400 ]]; then
              echo "æ£€æµ‹åˆ°é”™è¯¯æˆ–HTTPçŠ¶æ€ç å¼‚å¸¸ï¼ˆå°è¯•æ¬¡æ•°: $((retries+1))/$MAX_RETRIESï¼‰"
              retries=$((retries+1))
              
              if [ $retries -lt $MAX_RETRIES ]; then
                sleep_time=$((RETRY_DELAY * retries)) # æŒ‡æ•°é€€é¿å»¶è¿Ÿ
                echo "ç­‰å¾… $sleep_time ç§’åé‡è¯•..."
                sleep $sleep_time
              fi
            else
              # æˆåŠŸè·å–æœ‰æ•ˆå†…å®¹
              echo "$body" >> tvboxlist/iptv.txt
              echo >> tvboxlist/iptv.txt
              success=true
              break
            fi
          done

          # è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ä»æœªæˆåŠŸ
          if ! $success; then
            echo "å·²è·³è¿‡é“¾æ¥ï¼š$urlï¼ˆè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰" >&2
          fi

          # å›ºå®šé—´éš”ï¼ˆå¤„ç†å®Œä¸€ä¸ªé“¾æ¥åç­‰å¾…3ç§’ï¼‰
          sleep 3

        done < .github/workflows/iptv/iptvlist.txt
        
        awk '
        BEGIN {
            # è®¾ç½®å­—æ®µåˆ†éš”ç¬¦ä¸ºç©ºæ ¼æˆ–é€—å·
            FS="[,]";
        }
        {
            # åˆå§‹åŒ–å˜é‡
            tvg_name = ""; url = "";

            # åŒ¹é… tvg-name="xxxx"
            if (match($0, /tvg-name="([^"]*)"/, arr)) {
                tvg_name = arr[1];
            }

            # åŒ¹é…ä¸åŒ…å« .png çš„ URL
            for (i = 1; i <= NF; i++) {
                if ($i ~ /^https?:\/\/[^ ]+/ && $i !~ /\.png/) {
                    url = $i;
                    break;
                }
            }

            # å¦‚æœæ‰¾åˆ° tvg-name å’Œ URLï¼Œåˆ™æ›¿æ¢æ•´è¡Œä¸º "tvg_name,url"
            if (tvg_name != "" && url != "") {
                print tvg_name "," url;
            } else {
                # å¦‚æœä¸ç¬¦åˆæ¡ä»¶ï¼Œä¿ç•™åŸè¡Œ
                print $0;
            }
        }
        ' tvboxlist/iptv.txt > tvboxlist/iptvFormatOutput.txt
        grep -v -e '#genre#' -e 'å¹¿æ’­' -e 'éŸ©å›½å¥³å›¢' -e 'éŸ©å›½å¤ªå¦' -e 'éŸ©å›½æ­Œå›¢' -e 'éŸ©å›½åŠ¨æ„Ÿèˆæ›²' -e 'æ­Œå›¢â˜…' -e 'æ­ŒMV' -e 'æ–—é±¼' -e 'æ˜¥æ™š' -e 'Radio' -e 'ç”µå°' -e 'å°åº¦æ­Œèˆ' -e 'DJ' -e 'YY' tvboxlist/iptvFormatOutput.txt > tvboxlist/iptvFormatOutput2.txt
        awk -F',' '{split($2, links, "#"); for (i in links) print $1 "," links[i]}' tvboxlist/iptvFormatOutput2.txt > tvboxlist/iptvFormatOutput3.txt
        
        perl -pe '
            chomp;  # å»æ‰è¡Œå°¾çš„æ¢è¡Œç¬¦
            s/^([^,]*)(,.*)/$1$2/;  # å°†è¡Œåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šé€—å·å‰å’Œé€—å·å
            $first_part = $1;       # è·å–é€—å·å‰çš„éƒ¨åˆ†
            $rest = $2;             # è·å–é€—å·åçš„éƒ¨åˆ†

            # å¯¹é€—å·å‰çš„éƒ¨åˆ†è¿›è¡Œæ›¿æ¢æ“ä½œ
            $first_part =~ s/(?i)CETVæ—©æœŸæ•™è‚²/æ—©æœŸæ•™è‚²/g;
            $first_part =~ s/(?i)(newtv)/\U$1/g;
            $first_part =~ s/(?i)(cctv)/\U$1/g;
            $first_part =~ s/(?i)\QNEWTV \E/NEWTV/g;
            $first_part =~ s/(?i)\QNEWTV-\E/NEWTV/g;
            $first_part =~ s/(?i)\Qæ²³å—æ™´å½©ä¸­åŸ\E/æ™´å½©ä¸­åŸ/g;
            $first_part =~ s/(?i)\Qæ²³å—ç›å½©ä¸­åŸ\E/æ™´å½©ä¸­åŸ/g;
            $first_part =~ s/(?i)\QNEWTVå“’å•µèµ›äº‹\E/å“’å•µèµ›äº‹/g;
            $first_part =~ s/(?i)\QNEWTVå“’å•µç”µç«\E/å“’å•µç”µç«/g;
            $first_part =~ s/(?i)\QNEWTVå¤®å¹¿è´­ç‰©\E/å¤®å¹¿è´­ç‰©/g;
            $first_part =~ s/(?i)\QNEWTVä¸­è§†è´­ç‰©\E/ä¸­è§†è´­ç‰©/g;
            $first_part =~ s/(?i)\QNEWTVä¼˜è´­ç‰©\E/ä¼˜è´­ç‰©/g;
            $first_part =~ s/(?i)\QNEWTVç›å½©ç«æŠ€\E/ç›å½©ç«æŠ€/g;
            $first_part =~ s/(?i)\QNEWTVç²¾å½©å½±è§†\E/ç²¾å½©å½±è§†/g;
            $first_part =~ s/(?i)\QNEWTVç›å½©é’å°‘\E/ç›å½©é’å°‘/g;
            $first_part =~ s/(?i)\Qæ²³å—è¡›è¦–\E/æ²³å—å«è§†/g;
            $first_part =~ s/(?i)\QNEWTVæ­¦æä¸–ç•Œ\E/NEWTVæ­¦åšä¸–ç•Œ/g;
            $first_part =~ s/(?i)\Qå‘¨å£æ‰¶æ²Ÿ\E/æ‰¶æ²Ÿç»¼åˆ/g;
            $first_part =~ s/(?i)\Qæ²³å—è¡›è¦–\E/æ²³å—å«è§†/g;
            $first_part =~ s/(?i)\QCETV-\E/CETV/g;
            $first_part =~ s/(?i)\QCCTV-0\E/CCTV-/g;
            $first_part =~ s/(?i)\QCCTV0\E/CCTV-/g;
            $first_part =~ s/(?i)\QCCTV+\E/CCTV-/g;
            $first_part =~ s/(?i)\((.*?)\)|\[(.*?)\]|ã€Œ(.*?)ã€| |	|-é«˜æ¸…|é«˜æ¸…|é»‘é¾™æ±Ÿ\||ä¸­å¤®æ–°å½±-|ä¸­å¤®æ–°å½±|æ²³å—\||æ²³å—ï½œ|5.5M1080HEVC|7.5M1080HEVC|HEVC|æ ‡æ¸…|æ¹–å—-|4M1080|_6.8M1080_ç™¾è§†é€š|12M1080|2M1080|8M1080|7M1080|3.5M1080|3M1080|HD|2.5M1080|Max16M1080|4.5M1080|5M1080|ä»…ç§»åŠ¨|ä»…ipv6|å½±ipv6|âœ”åŸ|å®‰å¾½-|åŒ—äº¬IPTV|æµ™æ±Ÿ-|576//g;

            # å°†å¤„ç†åçš„ç¬¬ä¸€éƒ¨åˆ†å’Œç¬¬äºŒéƒ¨åˆ†é‡æ–°ç»„åˆ     CCTV-|CCTV|
            $_ = $first_part . $rest . "\n";  # æ˜¾å¼æ·»åŠ æ¢è¡Œç¬¦
        ' tvboxlist/iptvFormatOutput3.txt > tvboxlist/iptvTempOutput.txt

        awk -F'$' '{sub(/^[ \t]+|[ \t]+$/, "", $1); if (!seen[$1]++) print}' "tvboxlist/iptvTempOutput.txt" > "tvboxlist/iptvDeduplicationOutput.txt"
        sed -i -E 's/^(CCTV)([0-9]+)(.*,.*)/\1-\2\3/' tvboxlist/iptvDeduplicationOutput.txt
        sed -i -E 's/^(CCTV-[0-9]+)[^0-9,]*(,.*)/\1\2/' tvboxlist/iptvDeduplicationOutput.txt
        sed -i -E 's/^(CCTV-)([^0-9,]+)(,.*)/\2\3/' tvboxlist/iptvDeduplicationOutput.txt
        sed -i -E 's/^(CCTV)([^0-9,]+)(,.*)/\2\3/' tvboxlist/iptvDeduplicationOutput.txt
        
    - name: Apply åº”ç”¨
      run: |
        # å®šä¹‰äº†ä¸€ä¸ªæ•°ç»„ Emojiï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ªä¸åŒçš„ emoji è¡¨æƒ…
        Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
        # å°†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ·»åŠ åˆ° Git æš‚å­˜åŒº
        git add .
        # åˆ›å»ºä¸€ä¸ªæäº¤ï¼ŒåŒ…å«äº†éšæœºé€‰æ‹©çš„ emoji å’Œå½“å‰æ—¥æœŸæ—¶é—´ä½œä¸ºæäº¤ä¿¡æ¯
        git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(date +%Y-%m-%d" "%H:%M:%S)"
        # æ’¤é”€ä¸Šä¸€æ¬¡æäº¤ï¼Œä½†ä¿ç•™æ›´æ”¹
        git reset --soft HEAD^
        git add .
        git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(date +%Y-%m-%d" "%H:%M:%S)"
        # å¼ºåˆ¶æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“
        git push -f

    - name: Delete workflow runs åˆ é™¤å·¥ä½œæµè¿è¡Œ
      uses: Mattraks/delete-workflow-runs@main
      continue-on-error: true
      with:
        retain_days: 1
        keep_minimum_runs: 3
